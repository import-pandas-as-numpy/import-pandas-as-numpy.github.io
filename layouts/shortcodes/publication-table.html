{{- $items := site.Data.publications.referenced_work -}}
{{- if not $items -}}
<p>No publications configured.</p>
{{- else -}}
{{- $rows := slice -}}
{{- range $item := $items -}}
  {{- $url := $item.url -}}
  {{- $title := $item.title -}}
  {{- $summary := $item.summary | default "" -}}
  {{- $image := $item.image | default "" -}}
  {{- with resources.GetRemote $url -}}
    {{- $html := printf "%s" .Content -}}

    {{- if eq $title "" -}}
      {{- $ogTitleTags := findRE `(?is)<meta[^>]+property=["']og:title["'][^>]+content=["']([^"']+)["'][^>]*>` $html 1 -}}
      {{- $twTitleTags := findRE `(?is)<meta[^>]+name=["']twitter:title["'][^>]+content=["']([^"']+)["'][^>]*>` $html 1 -}}
      {{- if gt (len $ogTitleTags) 0 -}}
        {{- $title = replaceRE `(?is).*content=["']([^"']+)["'].*` "$1" (index $ogTitleTags 0) -}}
      {{- else if gt (len $twTitleTags) 0 -}}
        {{- $title = replaceRE `(?is).*content=["']([^"']+)["'].*` "$1" (index $twTitleTags 0) -}}
      {{- end -}}
    {{- end -}}

    {{- if eq $summary "" -}}
      {{- $twDescTags := findRE `(?is)<meta[^>]+name=["']twitter:description["'][^>]+content=["']([^"']+)["'][^>]*>` $html 1 -}}
      {{- $ogDescTags := findRE `(?is)<meta[^>]+property=["']og:description["'][^>]+content=["']([^"']+)["'][^>]*>` $html 1 -}}
      {{- $stdDescTags := findRE `(?is)<meta[^>]+name=["']description["'][^>]+content=["']([^"']+)["'][^>]*>` $html 1 -}}
      {{- if gt (len $twDescTags) 0 -}}
        {{- $summary = replaceRE `(?is).*content=["']([^"']+)["'].*` "$1" (index $twDescTags 0) -}}
      {{- else if gt (len $ogDescTags) 0 -}}
        {{- $summary = replaceRE `(?is).*content=["']([^"']+)["'].*` "$1" (index $ogDescTags 0) -}}
      {{- else if gt (len $stdDescTags) 0 -}}
        {{- $summary = replaceRE `(?is).*content=["']([^"']+)["'].*` "$1" (index $stdDescTags 0) -}}
      {{- end -}}
    {{- end -}}

    {{- if eq $image "" -}}
      {{- $twImageTags := findRE `(?is)<meta[^>]+(?:name|property)=["']twitter:image(?::src)?["'][^>]+content=["']([^"']+)["'][^>]*>` $html 1 -}}
      {{- $ogImageTags := findRE `(?is)<meta[^>]+property=["']og:image(?::secure_url)?["'][^>]+content=["']([^"']+)["'][^>]*>` $html 1 -}}
      {{- if gt (len $twImageTags) 0 -}}
        {{- $image = replaceRE `(?is).*content=["']([^"']+)["'].*` "$1" (index $twImageTags 0) -}}
      {{- else if gt (len $ogImageTags) 0 -}}
        {{- $image = replaceRE `(?is).*content=["']([^"']+)["'].*` "$1" (index $ogImageTags 0) -}}
      {{- end -}}

      {{- if hasPrefix $image "//" -}}
        {{- $image = printf "https:%s" $image -}}
      {{- else if hasPrefix $image "/" -}}
        {{- $origin := replaceRE `^(https?://[^/]+).*$` "$1" $url -}}
        {{- $image = printf "%s%s" $origin $image -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}

  {{- if eq $title "" -}}{{- $title = $url -}}{{- end -}}
  {{- $rows = $rows | append (dict
    "url" $url
    "title" $title
    "summary" $summary
    "image" $image
    "source" $item.source
    "date" (time.Format "02 Jan 2006" (time $item.date))
  ) -}}
{{- end -}}
<div class="pub-layout">
  <div class="pub-cards">
    {{- range $row := $rows -}}
      <article class="pub-card">
        <a class="pub-card-media" href="{{ $row.url }}" target="_blank" rel="noopener noreferrer">
          {{- if $row.image -}}
            <img src="{{ $row.image }}" alt="{{ $row.title }} preview image" class="nozoom" data-no-zoom="true" loading="lazy" decoding="async" />
          {{- else -}}
            <div class="pub-img-placeholder">No image</div>
          {{- end -}}
        </a>
        <div class="pub-card-body">
          <h3><a href="{{ $row.url }}" target="_blank" rel="noopener noreferrer">{{ $row.title }}</a></h3>
          {{- if $row.summary -}}<p>{{ $row.summary }}</p>{{- end -}}
          <p class="pub-card-meta">{{ $row.source }} | {{ $row.date }}</p>
        </div>
      </article>
    {{- end -}}
  </div>
</div>
{{- end -}}
